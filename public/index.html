<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Kaffeina Brand Deck 4D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-dark: #18253f;
      --bg-light: #223a63;
      --card: #ffffff;
      --card-shadow: 0 28px 60px rgba(10, 14, 35, 0.45);
      --outline: rgba(255, 255, 255, 0.18);
      --yellow: #f7d447;
      --teal: #3cc5c2;
      --orange: #ffb44d;
      --red: #ff595e;
      --green: #33c26d;
      --text-dark: #10223a;
      --text-light: #f1f5ff;
      --muted: rgba(241, 245, 255, 0.72);
      --radius: 32px;
      --transition: 180ms ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(100% 140% at 50% 0%, var(--bg-light) 0%, var(--bg-dark) 65%);
      color: var(--text-light);
      font-family: "Poppins", "Segoe UI", system-ui, -apple-system, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px 48px;
    }

    .app {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    .top-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
    }

    .brand-mark {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(15, 28, 52, 0.42);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      font-size: 13px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
    }

    .brand-mark img {
      height: 32px;
      width: 32px;
      object-fit: contain;
    }

    .app h1 {
      font-size: clamp(32px, 4vw, 44px);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 600;
      text-align: center;
    }

    .app p.lead {
      max-width: 560px;
      text-align: center;
      line-height: 1.6;
      color: var(--muted);
      font-size: 15px;
    }

    .screen {
      width: 100%;
      display: none;
      animation: fade-in 220ms ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .screen-intro {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    .deck-showcase {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 48px;
      flex-wrap: wrap;
    }

    .deck-card {
      width: clamp(240px, 40vw, 340px);
      aspect-ratio: 2.5 / 4;
      background: #1f3358;
      border-radius: 38px;
      box-shadow: var(--card-shadow);
      padding: 28px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fef9e8;
    }

    .deck-card .title {
      font-size: clamp(18px, 3vw, 24px);
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-weight: 600;
    }

    .deck-card .logo-word {
      margin-top: auto;
      font-size: clamp(22px, 4vw, 32px);
      font-weight: 600;
      line-height: 1.3;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .deck-card .logo-word span {
      font-size: clamp(16px, 3vw, 20px);
      letter-spacing: 0.1em;
    }

    .deck-card .doodles span {
      position: absolute;
      display: block;
      width: 48px;
      height: 48px;
      border: 2px solid rgba(255, 255, 255, 0.24);
      border-radius: 18px;
      opacity: 0.65;
    }

    .deck-card .doodles span:nth-child(1) { top: 38px; left: 30px; }
    .deck-card .doodles span:nth-child(2) { top: 38px; right: 28px; border-radius: 999px; }
    .deck-card .doodles span:nth-child(3) { bottom: 120px; left: 40px; border-radius: 50%; }
    .deck-card .doodles span:nth-child(4) { bottom: 48px; right: 36px; border-style: dashed; }
    .deck-card .doodles span:nth-child(5) { top: 160px; left: 50%; transform: translateX(-50%); border-radius: 999px 40px 999px 40px; }
    .deck-card .doodles span:nth-child(6) { top: 120px; right: 110px; border-radius: 12px; }

    .deck-card::after {
      content: "";
      position: absolute;
      inset: 24px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      pointer-events: none;
    }

    .preview-copy {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      text-align: center;
    }

    .card-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
    }

    .preview-card {
      border-radius: 28px;
      padding: 20px 18px;
      color: var(--text-dark);
      position: relative;
      box-shadow: 0 22px 45px rgba(11, 16, 31, 0.28);
    }

    .preview-card.yellow { background: #f8e27a; }
    .preview-card.teal { background: #75e3d4; }
    .preview-card.cyan { background: #7ee1ff; }
    .preview-card.green { background: #7ae5a0; }

    .preview-card .label {
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(0, 0, 0, 0.56);
    }

    .preview-card .word {
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.08em;
      margin: 12px 0 6px;
    }

    .preview-card .desc {
      font-size: 13px;
      line-height: 1.5;
      color: rgba(0, 0, 0, 0.68);
    }

    .cta {
      border: none;
      border-radius: 999px;
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--text-dark);
      background: var(--yellow);
      box-shadow: 0 20px 44px rgba(247, 212, 71, 0.35);
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 24px 60px rgba(247, 212, 71, 0.45);
    }

    .cta:active {
      transform: translateY(0);
    }

    .screen-game {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .game-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .game-header .logo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(15, 28, 52, 0.42);
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-size: 13px;
    }

    .game-header .logo img {
      height: 26px;
      width: 26px;
      object-fit: contain;
    }

    .game-header .progress {
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .stage {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: clamp(18px, 4vw, 48px);
      align-items: flex-end;
    }

    .stage.is-guide .stack-card { opacity: 0.35; }
    .stage.is-guide .stack-count,
    .stage.is-guide .stack-label { opacity: 0.4; }

    .card-stack,
    .card-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      font-size: 13px;
    }

    .stack-card {
      width: clamp(160px, 24vw, 220px);
      aspect-ratio: 2.5 / 4;
      border-radius: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--card-shadow);
      color: rgba(255, 255, 255, 0.92);
      position: relative;
    }

    .stack-card::after {
      content: "";
      position: absolute;
      inset: 22px;
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      opacity: 0.3;
      pointer-events: none;
    }

    .card-stack.negative .stack-card { background: linear-gradient(180deg, #ff6b6f 0%, #d94155 100%); }
    .card-stack.positive .stack-card { background: linear-gradient(180deg, #52dc7c 0%, #1fa45c 100%); }

    .stack-symbol {
      font-size: clamp(40px, 8vw, 64px);
      font-weight: 700;
    }

    .stack-count {
      font-size: clamp(26px, 5vw, 38px);
    }

    .stack-label {
      color: rgba(255, 255, 255, 0.76);
    }

    .card-main {
      width: clamp(210px, 28vw, 280px);
      aspect-ratio: 2.5 / 4;
      border-radius: 40px;
      background: var(--card);
      color: var(--text-dark);
      box-shadow: var(--card-shadow);
      position: relative;
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      justify-content: center;
      align-items: center;
      text-align: center;
      overflow: hidden;
    }

    .card-main::before {
      content: "";
      position: absolute;
      inset: 24px;
      border-radius: 30px;
      border: 1px solid rgba(16, 34, 58, 0.06);
      pointer-events: none;
    }

    .card-badge {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(16, 34, 58, 0.6);
      font-weight: 600;
    }

    .card-word {
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 700;
      letter-spacing: 0.14em;
    }

    .card-sub {
      font-size: 16px;
      line-height: 1.5;
      color: rgba(16, 34, 58, 0.72);
      max-width: 220px;
    }

    .guide-note {
      margin-top: 12px;
      font-size: 13px;
      color: rgba(16, 34, 58, 0.56);
    }

    .reveal-btn {
      margin-top: 24px;
      border: none;
      border-radius: 999px;
      background: var(--bg-light);
      color: #fff;
      padding: 12px 24px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition);
      box-shadow: 0 16px 32px rgba(34, 58, 99, 0.35);
    }

    .reveal-btn:hover { transform: translateY(-2px); }
    .reveal-btn:active { transform: translateY(0); }

    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(18px, 6vw, 80px);
      flex-wrap: wrap;
    }

    .control-btn {
      min-width: 150px;
      border: none;
      border-radius: 999px;
      padding: 14px 30px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 20px 44px rgba(0, 0, 0, 0.35);
      transition: transform var(--transition), box-shadow var(--transition), filter var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .control-btn:hover {
      transform: translateY(-3px);
      filter: brightness(1.05);
    }

    .control-btn:disabled {
      cursor: not-allowed;
      opacity: 0.4;
      transform: none;
      box-shadow: none;
      filter: none;
    }

    .control-btn.negative { background: linear-gradient(180deg, #ff6b6f 0%, #d94155 100%); }
    .control-btn.positive { background: linear-gradient(180deg, #52dc7c 0%, #1fa45c 100%); }
    .control-btn.undo {
      background: rgba(15, 28, 52, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.18);
      min-width: auto;
      padding: 14px 22px;
    }

    .screen-end {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }

    .final-stage {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: clamp(18px, 5vw, 48px);
      align-items: center;
      width: 100%;
    }

    .side-result {
      border-radius: 36px;
      padding: 32px 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--card-shadow);
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 13px;
    }

    .side-result .count {
      font-size: clamp(40px, 6vw, 52px);
    }

    .side-result.negative { background: linear-gradient(200deg, #ff6b6f 0%, #d94155 100%); }
    .side-result.positive { background: linear-gradient(200deg, #52dc7c 0%, #1fa45c 100%); }

    .final-card {
      width: min(320px, 90vw);
      margin: 0 auto;
    }

    .final-card .card-sub {
      max-width: 260px;
    }

    .final-card .control-btn {
      width: 100%;
      justify-content: center;
      margin-top: 16px;
    }

    .ai-box {
      margin-top: 24px;
      width: 100%;
      background: rgba(12, 22, 44, 0.8);
      border-radius: 24px;
      padding: 18px 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .ai-box strong {
      letter-spacing: 0.08em;
      font-size: 13px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .ai-output {
      margin-top: 12px;
      max-height: 240px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.5;
      background: rgba(3, 10, 24, 0.6);
      border-radius: 16px;
      padding: 14px;
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, "Liberation Mono", monospace;
      color: #e2e8f0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .restart {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.26);
      color: var(--muted);
      padding: 12px 28px;
      border-radius: 999px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      transition: color var(--transition), border var(--transition), transform var(--transition);
    }

    .restart:hover {
      color: #fff;
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    @media (max-width: 900px) {
      .controls { gap: 24px; }
      .control-btn { min-width: 140px; }
      .game-header { justify-content: center; }
    }

    @media (max-width: 640px) {
      body { padding-bottom: 64px; }
      .stage { grid-template-columns: 1fr; }
      .card-stack { order: 1; }
      .card-center { order: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top-bar">
      <div class="brand-mark">
        <img src="./assets/logo.png" alt="Brand Deck 4D" />
        brand deck 4d
      </div>
      <h1>Mazzo di carte</h1>
      <p class="lead">Where Ideas Come to Life. Anche nella strategia dei brand.</p>
    </div>

    <section class="screen screen-intro active" id="screenIntro">
      <div class="deck-showcase">
        <div class="deck-card">
          <div class="doodles">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="title">Il tuo mazzo</div>
          <div class="logo-word">
            <span>brand deck 4D</span>
            Kaffeina
          </div>
        </div>
        <div>
          <div class="preview-copy">Fronte carte, 1 per tipo</div>
          <div class="card-preview-grid">
            <div class="preview-card yellow">
              <div class="label">Autentico</div>
              <div class="word">AUTENTICO</div>
              <div class="desc">Ciò che crei ti rappresenta.</div>
            </div>
            <div class="preview-card teal">
              <div class="label">Affidabile</div>
              <div class="word">AFFIDABILE</div>
              <div class="desc">Prometti solo ciò che puoi mantenere.</div>
            </div>
            <div class="preview-card cyan">
              <div class="label">Innovativo</div>
              <div class="word">INNOVATIVO</div>
              <div class="desc">Reinventi ogni giorno il modo di comunicare.</div>
            </div>
            <div class="preview-card green">
              <div class="label">Strategico</div>
              <div class="word">STRATEGICO</div>
              <div class="desc">Vedi il quadro completo.</div>
            </div>
          </div>
        </div>
      </div>
      <button class="cta" id="btnStart">Inizia</button>
    </section>

    <section class="screen screen-game" id="screenGame">
      <div class="game-header">
        <div class="logo">
          <img src="./assets/logo.png" alt="Kaffeina" />
          brand deck 4d
        </div>
        <div class="progress" id="gameProgress">Carta 1 di 80</div>
      </div>
      <div class="stage is-guide" id="cardStage">
        <div class="card-stack negative">
          <div class="stack-card">
            <span class="stack-symbol">✕</span>
          </div>
          <div class="stack-count" id="countNo">0</div>
          <div class="stack-label">NO</div>
        </div>
        <div class="card-center">
          <div class="card-main" id="activeCard">
            <div class="card-badge" id="cardDimension">brand deck 4d</div>
            <div class="card-word" id="cardWord">Inizia!</div>
            <div class="card-sub" id="cardSub">Guarda la carta e scegli se tenerla o buttarla.</div>
            <p class="guide-note" id="guideNote">Pensa al brand come se fosse una persona: lo rappresenta davvero?</p>
            <button class="reveal-btn" id="btnReveal">Mostra la prima carta</button>
          </div>
        </div>
        <div class="card-stack positive">
          <div class="stack-card">
            <span class="stack-symbol">✓</span>
          </div>
          <div class="stack-count" id="countYes">0</div>
          <div class="stack-label">SÌ</div>
        </div>
      </div>
      <div class="controls">
        <button class="control-btn negative" id="btnNo">Scarta</button>
        <button class="control-btn undo" id="btnUndo">Undo</button>
        <button class="control-btn positive" id="btnYes">Tieni</button>
      </div>
    </section>

    <section class="screen screen-end" id="screenEnd">
      <div class="final-stage">
        <div class="side-result negative">
          <div class="count" id="finalNo">0</div>
          <div>Scartate</div>
        </div>
        <div class="card-main final-card">
          <div class="card-badge">brand deck 4d</div>
          <div class="card-word">Fatto!</div>
          <div class="card-sub">Ora potrai visualizzare il risultato del Brand Deck 4D e analizzarlo con l’intelligenza artificiale.</div>
          <button class="control-btn positive" id="btnAnalyze">Analizza con AI</button>
          <div class="ai-box" id="aiBox" style="display:none;">
            <strong>Output dell’agente</strong>
            <div class="ai-output" id="aiOutput">{ }</div>
          </div>
        </div>
        <div class="side-result positive">
          <div class="count" id="finalYes">0</div>
          <div>Tenute</div>
        </div>
      </div>
      <button class="restart" id="btnRestart">Ricomincia</button>
    </section>
  </div>

  <script>
    const DECK = [

      {"id":1,"text":"Autentico – Ciò che crei ti rappresenta.","dimension":"Essence","archetypes":["Innocente","Amico"]},
      {"id":2,"text":"Visionario – Vedi strade dove altri vedono muri.","dimension":"Essence","archetypes":["Creatore","Mago"]},
      {"id":3,"text":"Ironico – Usi il sorriso per dire cose serie.","dimension":"Essence","archetypes":["Buffone","Ribelle"]},
      {"id":4,"text":"Libero – Nessuna idea vive in gabbia.","dimension":"Essence","archetypes":["Ribelle","Esploratore"]},
      {"id":5,"text":"Elegante – Stile, mai ostentazione.","dimension":"Essence","archetypes":["Amante","Sovrano"]},
      {"id":6,"text":"Coraggioso – Ti lanci anche quando non c’è rete.","dimension":"Essence","archetypes":["Eroe","Ribelle"]},
      {"id":7,"text":"Empatico – Capisci prima di spiegare.","dimension":"Essence","archetypes":["Amico","Caregiver"]},
      {"id":8,"text":"Creativo – L’originalità è il tuo respiro naturale.","dimension":"Essence","archetypes":["Creatore","Amante"]},
      {"id":9,"text":"Sincero – Nessuna posa, solo sostanza.","dimension":"Essence","archetypes":["Innocente","Saggio"]},
      {"id":10,"text":"Appassionato – Metti il cuore in ogni idea.","dimension":"Essence","archetypes":["Amante","Eroe"]},
      {"id":11,"text":"Intuitivo – Le intuizioni arrivano prima dei dati.","dimension":"Essence","archetypes":["Mago","Saggio"]},
      {"id":12,"text":"Onesto – Dici la verità, anche quando spiazza.","dimension":"Essence","archetypes":["Innocente","Caregiver"]},
      {"id":13,"text":"Poetico – Trasformi la realtà in racconto.","dimension":"Essence","archetypes":["Creatore","Amante"]},
      {"id":14,"text":"Umile – Nessun ego, solo risultati.","dimension":"Essence","archetypes":["Amico","Caregiver"]},
      {"id":15,"text":"Lucido – Sai fermarti a guardare.","dimension":"Essence","archetypes":["Saggio","Creatore"]},
      {"id":16,"text":"Aperto – Ogni punto di vista è un orizzonte.","dimension":"Essence","archetypes":["Esploratore","Amico"]},
      {"id":17,"text":"Sostenibile – Pensi a lungo termine, non alla moda.","dimension":"Essence","archetypes":["Saggio","Innocente"]},
      {"id":18,"text":"Iconico – Le tue idee restano impresse.","dimension":"Essence","archetypes":["Creatore","Sovrano"]},
      {"id":19,"text":"Irrequieto – Ti muove la curiosità, non l’abitudine.","dimension":"Essence","archetypes":["Ribelle","Esploratore"]},
      {"id":20,"text":"Autodidatta – Impari facendo, sempre.","dimension":"Essence","archetypes":["Eroe","Saggio"]},

      {"id":21,"text":"Affidabile – Prometti solo ciò che puoi mantenere.","dimension":"Purpose","archetypes":["Sovrano","Caregiver"]},
      {"id":22,"text":"Umano – La scienza parla attraverso le persone.","dimension":"Purpose","archetypes":["Caregiver","Amico"]},
      {"id":23,"text":"Chiaro – Complesso non vuol dire incomprensibile.","dimension":"Purpose","archetypes":["Saggio","Innocente"]},
      {"id":24,"text":"Rassicurante – Calmi le menti prima dei numeri.","dimension":"Purpose","archetypes":["Caregiver","Innocente"]},
      {"id":25,"text":"Etico – Fai la cosa giusta, anche se non conviene.","dimension":"Purpose","archetypes":["Sovrano","Saggio"]},
      {"id":26,"text":"Accogliente – Ogni messaggio è uno spazio sicuro.","dimension":"Purpose","archetypes":["Caregiver","Amico"]},
      {"id":27,"text":"Educativo – Condividi conoscenza, non solo dati.","dimension":"Purpose","archetypes":["Saggio","Mago"]},
      {"id":28,"text":"Empatico – Ascolti prima di parlare.","dimension":"Purpose","archetypes":["Caregiver","Amico"]},
      {"id":29,"text":"Trasparente – Non nascondi dietro al linguaggio.","dimension":"Purpose","archetypes":["Innocente","Saggio"]},
      {"id":30,"text":"Paziente – La fiducia cresce nel tempo.","dimension":"Purpose","archetypes":["Caregiver","Saggio"]},
      {"id":31,"text":"Scientifico – Ogni parola pesa.","dimension":"Purpose","archetypes":["Saggio","Sovrano"]},
      {"id":32,"text":"Leggero – La semplicità è la forma più alta di rispetto.","dimension":"Purpose","archetypes":["Innocente","Amico"]},
      {"id":33,"text":"Delicato – La sensibilità è la tua forza.","dimension":"Purpose","archetypes":["Caregiver","Amante"]},
      {"id":34,"text":"Inclusivo – Nessuno resta indietro.","dimension":"Purpose","archetypes":["Amico","Innocente"]},
      {"id":35,"text":"Autorevole – Guida con competenza, non con toni alti.","dimension":"Purpose","archetypes":["Sovrano","Saggio"]},
      {"id":36,"text":"Protettivo – Offri sicurezza, non controllo.","dimension":"Purpose","archetypes":["Caregiver","Sovrano"]},
      {"id":37,"text":"Chiaro di intenti – Etica e chiarezza camminano insieme.","dimension":"Purpose","archetypes":["Saggio","Caregiver"]},
      {"id":38,"text":"Discreto – Il rispetto si misura nel silenzio.","dimension":"Purpose","archetypes":["Caregiver","Saggio"]},
      {"id":39,"text":"Lucido – La mente al servizio della cura.","dimension":"Purpose","archetypes":["Saggio","Caregiver"]},
      {"id":40,"text":"Empowerment – Aiuti le persone a sentirsi capaci.","dimension":"Purpose","archetypes":["Eroe","Caregiver"]},

      {"id":41,"text":"Innovativo – Reinventi ogni giorno il modo di comunicare.","dimension":"Expression","archetypes":["Mago","Creatore"]},
      {"id":42,"text":"Analitico – L’intuizione va misurata.","dimension":"Expression","archetypes":["Saggio","Mago"]},
      {"id":43,"text":"Sperimentale – Testi, sbagli, migliori.","dimension":"Expression","archetypes":["Ribelle","Creatore"]},
      {"id":44,"text":"Strategico – Ogni insight diventa direzione.","dimension":"Expression","archetypes":["Eroe","Sovrano"]},
      {"id":45,"text":"Visionario – La tecnologia è la tua tela.","dimension":"Expression","archetypes":["Mago","Creatore"]},
      {"id":46,"text":"Accessibile – L’innovazione deve includere, non escludere.","dimension":"Expression","archetypes":["Amico","Innocente"]},
      {"id":47,"text":"Rapido – Il timing è parte del talento.","dimension":"Expression","archetypes":["Eroe","Mago"]},
      {"id":48,"text":"Essenziale – La chiarezza è la nuova UX.","dimension":"Expression","archetypes":["Saggio","Creatore"]},
      {"id":49,"text":"Preciso – La qualità è una questione di pixel.","dimension":"Expression","archetypes":["Sovrano","Saggio"]},
      {"id":50,"text":"Disruptive – Cambi le regole, ma con metodo.","dimension":"Expression","archetypes":["Ribelle","Eroe"]},
      {"id":51,"text":"Intelligente – Usi la logica per liberare la creatività.","dimension":"Expression","archetypes":["Mago","Saggio"]},
      {"id":52,"text":"Digitale – Parli il linguaggio dei bit, pensi come un umano.","dimension":"Expression","archetypes":["Mago","Amico"]},
      {"id":53,"text":"Connesso – Tutto comunica, se sai ascoltare.","dimension":"Expression","archetypes":["Mago","Amico"]},
      {"id":54,"text":"Metodico – L’innovazione nasce dal processo.","dimension":"Expression","archetypes":["Saggio","Creatore"]},
      {"id":55,"text":"Evolutivo – Resti in movimento.","dimension":"Expression","archetypes":["Esploratore","Eroe"]},
      {"id":56,"text":"Proattivo – Ti muovi prima che serva.","dimension":"Expression","archetypes":["Eroe","Mago"]},
      {"id":57,"text":"Dinamico – Ti adatti senza perdere forma.","dimension":"Expression","archetypes":["Eroe","Creatore"]},
      {"id":58,"text":"Tecnologico – Ogni innovazione parte da un’intenzione.","dimension":"Expression","archetypes":["Mago","Sovrano"]},
      {"id":59,"text":"Empirico – Provi, osservi, correggi.","dimension":"Expression","archetypes":["Saggio","Esploratore"]},
      {"id":60,"text":"Curioso – La scoperta è il tuo motore.","dimension":"Expression","archetypes":["Esploratore","Amico"]},

      {"id":61,"text":"Strategico – Vedi il quadro completo.","dimension":"Impact","archetypes":["Sovrano","Saggio"]},
      {"id":62,"text":"Collaborativo – Il successo è una costruzione collettiva.","dimension":"Impact","archetypes":["Amico","Caregiver"]},
      {"id":63,"text":"Affidabile – Mantieni promesse, costruisci fiducia.","dimension":"Impact","archetypes":["Sovrano","Caregiver"]},
      {"id":64,"text":"Pratico – Idee che funzionano davvero.","dimension":"Impact","archetypes":["Eroe","Saggio"]},
      {"id":65,"text":"Energico – Coinvolgi con entusiasmo.","dimension":"Impact","archetypes":["Eroe","Amante"]},
      {"id":66,"text":"Tenace – La costanza è la tua forza.","dimension":"Impact","archetypes":["Eroe","Sovrano"]},
      {"id":67,"text":"Istituzionale – Ogni contesto ha il suo codice.","dimension":"Impact","archetypes":["Sovrano","Saggio"]},
      {"id":68,"text":"Empatico – Sai leggere le persone oltre i brief.","dimension":"Impact","archetypes":["Amico","Caregiver"]},
      {"id":69,"text":"Coerente – Tutto racconta la stessa storia.","dimension":"Impact","archetypes":["Sovrano","Saggio"]},
      {"id":70,"text":"Motivante – Fai emergere il meglio dagli altri.","dimension":"Impact","archetypes":["Eroe","Amico"]},
      {"id":71,"text":"Efficiente – L’organizzazione è creatività applicata.","dimension":"Impact","archetypes":["Sovrano","Eroe"]},
      {"id":72,"text":"Attento – Noti i dettagli che contano.","dimension":"Impact","archetypes":["Caregiver","Saggio"]},
      {"id":73,"text":"Risolutivo – Ogni problema è un invito all’azione.","dimension":"Impact","archetypes":["Eroe","Mago"]},
      {"id":74,"text":"Solido – Sei la base su cui costruire.","dimension":"Impact","archetypes":["Sovrano","Caregiver"]},
      {"id":75,"text":"Positivo – L’ottimismo è una strategia.","dimension":"Impact","archetypes":["Innocente","Amico"]},
      {"id":76,"text":"Ordinato – La chiarezza genera fiducia.","dimension":"Impact","archetypes":["Sovrano","Saggio"]},
      {"id":77,"text":"Generoso – Condividi esperienza, non solo risultati.","dimension":"Impact","archetypes":["Caregiver","Amico"]},
      {"id":78,"text":"Affabile – Le relazioni prima dei ruoli.","dimension":"Impact","archetypes":["Amico","Innocente"]},
      {"id":79,"text":"Credibile – Ogni azione parla più delle parole.","dimension":"Impact","archetypes":["Eroe","Sovrano"]},
      {"id":80,"text":"Connesso – Trasformi i progetti in legami.","dimension":"Impact","archetypes":["Caregiver","Amico"]}

    ];

    const state = {
      order: [],
      idx: 0,
      decisions: new Map(),
      undoStack: [],
      results: null,
      phase: "onboarding"
    };

    const $ = (sel) => document.querySelector(sel);

    const screenCover = $("#screenCover");
    const screenCategories = $("#screenCategories");
    const screenStart = $("#screenStart");
    const screenGame = $("#screenGame");
    const screenEnd = $("#screenEnd");
    const cardStage = $("#cardStage");
    const cardDimension = $("#cardDimension");
    const cardWord = $("#cardWord");
    const cardSub = $("#cardSub");
    const guideNote = $("#guideNote");
    const btnStart = $("#btnStart");
    const btnReveal = $("#btnReveal");
    const btnYes = $("#btnYes");
    const btnNo = $("#btnNo");
    const btnUndo = $("#btnUndo");
    const btnAnalyze = $("#btnAnalyze");
    const btnRestart = $("#btnRestart");
    const cardCounter = $("#gameProgress");
    const countYes = $("#countYes");
    const countNo = $("#countNo");
    const finalYes = $("#finalYes");
    const finalNo = $("#finalNo");
    const aiBox = $("#aiBox");
    const aiOutput = $("#aiOutput");

    const TOTAL_CARDS = DECK.length;

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function startDeck() {
      state.order = shuffle([...DECK.keys()]);
      state.idx = 0;
      state.decisions.clear();
      state.undoStack = [];
      state.results = null;
      state.phase = "guide";
      if (aiBox) aiBox.style.display = "none";
      if (aiOutput) aiOutput.textContent = "{ }";
      updateUI();
    }

    function revealFirstCard() {
      if (state.phase !== "guide") return;
      state.phase = "playing";
      updateUI();
    }

    function currentCard() {
      if (state.idx < 0 || state.idx >= state.order.length) return null;
      const index = state.order[state.idx];
      return DECK[index];
    }

    function renderCard() {
      const c = currentCard();
      if (!c) return;
      const [rawWord, rawSub] = c.text.split("–");
      cardDimension.textContent = c.dimension || "";
      cardWord.textContent = (rawWord || c.text || "").trim().toUpperCase();
      cardSub.textContent = (rawSub || c.text || "").trim();
    }

    function updateCounters() {
      const yes = [...state.decisions.values()].filter((v) => v === true).length;
      const no = [...state.decisions.values()].filter((v) => v === false).length;

      if (countYes) countYes.textContent = String(yes);
      if (countNo) countNo.textContent = String(no);
      if (finalYes) finalYes.textContent = String(yes);
      if (finalNo) finalNo.textContent = String(no);
    }

    function updateUI() {
      screenIntro?.classList.toggle("active", state.phase === "onboarding");
      screenGame?.classList.toggle("active", state.phase === "guide" || state.phase === "playing");
      screenEnd?.classList.toggle("active", state.phase === "complete");

      if (cardStage) cardStage.classList.toggle("is-guide", state.phase === "guide");

      if (state.phase === "guide") {
        cardDimension.textContent = "brand deck 4d";
        cardWord.textContent = "INIZIA!";
        cardSub.textContent = "Guarda la carta e scegli se tenerla o buttarla.";
        if (guideNote) guideNote.style.display = "";
        if (btnReveal) btnReveal.style.display = "";
      } else if (state.phase === "playing") {
        renderCard();
        if (guideNote) guideNote.style.display = "none";
        if (btnReveal) btnReveal.style.display = "none";
      } else {
        if (guideNote) guideNote.style.display = "none";
        if (btnReveal) btnReveal.style.display = "none";
      }

      const progressText = (() => {
        if (state.phase === "complete") return `Completato ${TOTAL_CARDS} / ${TOTAL_CARDS}`;
        if (state.phase === "playing") return `Carta ${Math.min(state.idx + 1, TOTAL_CARDS)} di ${TOTAL_CARDS}`;
        return `Carta 1 di ${TOTAL_CARDS}`;
      })();
      if (cardCounter) cardCounter.textContent = progressText;

      if (btnYes) btnYes.disabled = state.phase !== "playing";
      if (btnNo) btnNo.disabled = state.phase !== "playing";
      if (btnUndo) btnUndo.disabled = state.phase !== "playing" || state.undoStack.length === 0;
      if (btnAnalyze) btnAnalyze.disabled = state.phase !== "complete";

      if (state.phase !== "complete" && aiBox) {
        aiBox.style.display = "none";
      }

      updateCounters();
    }

    function decide(yes) {
      if (state.phase !== "playing") return;
      const c = currentCard();
      if (!c) return;
      state.decisions.set(c.id, yes);
      state.undoStack.push({ id: c.id, decision: yes, idx: state.idx });
      state.idx++;
      if (state.idx >= TOTAL_CARDS) {
        buildResults();
        state.phase = "complete";
      }
      updateUI();
    }

    function undo() {
      const last = state.undoStack.pop();
      if (!last) return;
      state.decisions.delete(last.id);
      state.idx = last.idx;
      state.phase = "playing";
      updateUI();
    }

    function buildResults() {
      const selectedIds = [...state.decisions.entries()]
        .filter(([_, v]) => v === true)
        .map(([id]) => id);
      const selectedCards = DECK.filter((c) => selectedIds.includes(c.id));

      const dims = { Essence: 0, Purpose: 0, Expression: 0, Impact: 0 };
      const archetypeKeys = ["Amante","Amico","Buffone","Caregiver","Creatore","Eroe","Esploratore","Innocente","Mago","Non Evoluto","Ribelle","Saggio","Sovrano"];
      const arch = Object.fromEntries(archetypeKeys.map((k) => [k, 0]));

      for (const c of selectedCards) {
        if (dims[c.dimension] != null) dims[c.dimension]++;
        for (const a of c.archetypes || []) {
          if (arch[a] != null) arch[a]++;
        }
      }

      state.results = {
        total: TOTAL_CARDS,
        selected: selectedCards.length,
        byDimension: dims,
        byArchetype: arch,
        decisions: [...state.decisions.entries()].map(([id, accepted]) => {
          const c = DECK.find((x) => x.id === id);
          return {
            id,
            accepted,
            text: c?.text,
            dimension: c?.dimension,
            archetypes: c?.archetypes
          };
        })
      };
    }

    async function analyzeWithAI() {
      if (!state.results) {
        alert("Completa prima il mazzo.");
        return;
      }
      if (aiBox) aiBox.style.display = "";
      if (aiOutput) aiOutput.textContent = "Analisi in corso...";
      if (btnAnalyze) btnAnalyze.disabled = true;

      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(state.results)
        });
        const data = await res.json();
        if (!data.ok) {
          if (aiOutput) aiOutput.textContent = "Errore nell'analisi AI: " + (data.error || "sconosciuto");
          return;
        }
        if (aiOutput) aiOutput.textContent = JSON.stringify(data.analysis, null, 2);
      } catch (err) {
        if (aiOutput) aiOutput.textContent = "Errore di rete o server: " + String(err);
      } finally {
        if (btnAnalyze) btnAnalyze.disabled = false;
      }
    }

    btnStart?.addEventListener("click", startDeck);
    btnReveal?.addEventListener("click", revealFirstCard);
    btnYes?.addEventListener("click", () => decide(true));
    btnNo?.addEventListener("click", () => decide(false));
    btnUndo?.addEventListener("click", undo);
    btnAnalyze?.addEventListener("click", analyzeWithAI);
    btnRestart?.addEventListener("click", () => {
      state.order = [];
      state.idx = 0;
      state.decisions.clear();
      state.undoStack = [];
      state.results = null;
      state.phase = "onboarding";
      if (aiBox) aiBox.style.display = "none";
      if (aiOutput) aiOutput.textContent = "{ }";
      updateUI();
    });

    window.addEventListener("keydown", (e) => {
      const key = e.key.toLowerCase();
      if (state.phase === "guide" && (key === "enter" || key === " ")) {
        revealFirstCard();
        return;
      }
      if (state.phase !== "playing") return;
      if (key === "arrowright" || key === "y" || key === "s") decide(true);
      else if (key === "arrowleft" || key === "n") decide(false);
      else if (key === "u" || key === "backspace") undo();
    });

    updateUI();
  </script>
</body>
</html>
